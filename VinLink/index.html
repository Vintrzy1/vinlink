<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VinLink - Shortlink</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* Gaya Tampilan Modern Dark Mode */
        body {
            background-color: #1a1a2e;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background: #16213e;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        h1 { color: #e94560; margin-bottom: 20px; }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #0f3460;
            border: none;
            color: white;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .btn-main {
            width: 100%;
            padding: 12px;
            background: #e94560;
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-main:hover { background: #c1354b; }
        
        /* Style untuk area hasil link */
        #result { margin-top: 15px; font-size: 0.9rem; }
        .result-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #0f3460;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #e94560;
        }
        .result-link {
            color: #fff;
            text-decoration: none;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-right: 10px;
            max-width: 200px;
        }
        .btn-copy {
            background: #e94560;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-copy:active { background: #fff; color: #e94560; }
        
        .loading { display: none; color: #aaa; }
    </style>
</head>
<body>

    <div class="container" id="mainApp">
        <h1>VinLink</h1>
        <input type="text" id="longUrl" placeholder="Tempel Link Panjang di sini...">
        <input type="text" id="customCode" placeholder="Kode Kustom (Opsional, cth: promo)">
        <button class="btn-main" onclick="shortenUrl()">Pendekkan!</button>
        <div id="result"></div>
    </div>

    <div id="redirectMsg" style="display:none; text-align:center;">
        <h2>Sedang mengalihkan...</h2>
        <p>Tunggu sebentar ya.</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        // Konfigurasi Kamu
        const firebaseConfig = {
            apiKey: "AIzaSyBEdeZ2qPIu8tNpnSftcvrbwwRxwR7aVd8",
            authDomain: "vinlink-f71e9.firebaseapp.com",
            projectId: "vinlink-f71e9",
            storageBucket: "vinlink-f71e9.firebasestorage.app",
            messagingSenderId: "432170574840",
            appId: "1:432170574840:web:e09875cddcaa300cd06c0d",
            measurementId: "G-VFDRDVKLVD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- FUNGSI 1: CEK REDIRECT ---
        async function checkRedirect() {
            const path = window.location.pathname.substring(1); 
            if (path && path !== "" && path !== "index.html") {
                document.getElementById("mainApp").style.display = "none";
                document.getElementById("redirectMsg").style.display = "block";
                try {
                    const docRef = doc(db, "links", path);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        window.location.href = docSnap.data().url;
                    } else {
                        document.getElementById("redirectMsg").innerHTML = "<h2>Link tidak ditemukan :(</h2><a href='/'>Buat baru</a>";
                    }
                } catch (error) {
                    console.error("Error:", error);
                }
            }
        }

        // --- FUNGSI 2: MEMBUAT SHORTLINK ---
        window.shortenUrl = async function() {
            const longUrl = document.getElementById('longUrl').value;
            let code = document.getElementById('customCode').value;
            const resultDiv = document.getElementById('result');

            if (!longUrl) return alert("Isi linknya dulu dong!");
            if (!code) code = Math.random().toString(36).substring(2, 7);

            resultDiv.innerHTML = "<span class='loading'>Memproses...</span>";

            try {
                await setDoc(doc(db, "links", code), {
                    url: longUrl,
                    createdAt: new Date()
                });

                const shortUrl = window.location.origin + "/" + code;
                
                // TAMPILAN BARU DENGAN TOMBOL COPY
                resultDiv.innerHTML = `
                    <div class="result-box">
                        <a href="${shortUrl}" target="_blank" class="result-link">${shortUrl}</a>
                        <button class="btn-copy" onclick="copyLink('${shortUrl}')">Salin</button>
                    </div>
                `;
            } catch (error) {
                console.error(error);
                resultDiv.innerText = "Gagal membuat link. Cek konsol.";
            }
        }

        // --- FUNGSI 3: FITUR COPY ---
        window.copyLink = function(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("Link berhasil disalin!");
            }).catch(err => {
                console.error('Gagal menyalin', err);
            });
        }

        checkRedirect();
    </script>
</body>
</html>
