<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VinLink - Shortlink</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* Gaya Tampilan Modern Dark Mode */
        body {
            background-color: #1a1a2e;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background: #16213e;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        h1 { color: #e94560; margin-bottom: 20px; }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #0f3460;
            border: none;
            color: white;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #e94560;
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover { background: #c1354b; }
        #result { margin-top: 15px; font-size: 0.9rem; word-break: break-all; }
        .loading { display: none; color: #aaa; }
    </style>
</head>
<body>

    <div class="container" id="mainApp">
        <h1>VinLink</h1>
        <input type="text" id="longUrl" placeholder="Tempel Link Panjang di sini...">
        <input type="text" id="customCode" placeholder="Kode Kustom (Opsional, cth: promo)">
        <button onclick="shortenUrl()">Pendekkan!</button>
        <div id="result"></div>
    </div>

    <div id="redirectMsg" style="display:none; text-align:center;">
        <h2>Sedang mengalihkan...</h2>
        <p>Tunggu sebentar ya.</p>
    </div>

    <script type="module">
        // Import fungsi-fungsi penting dari Firebase (Menggunakan versi 12.8.0 sesuai data kamu)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
        // Kita tambah ini untuk Database:
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        // Konfigurasi Kamu (Sudah Saya Masukkan)
        const firebaseConfig = {
            apiKey: "AIzaSyBEdeZ2qPIu8tNpnSftcvrbwwRxwR7aVd8",
            authDomain: "vinlink-f71e9.firebaseapp.com",
            projectId: "vinlink-f71e9",
            storageBucket: "vinlink-f71e9.firebasestorage.app",
            messagingSenderId: "432170574840",
            appId: "1:432170574840:web:e09875cddcaa300cd06c0d",
            measurementId: "G-VFDRDVKLVD"
        };

        // Mulai Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app); // Ini untuk database

        // --- FUNGSI 1: CEK REDIRECT ---
        async function checkRedirect() {
            const path = window.location.pathname.substring(1); 

            if (path && path !== "" && path !== "index.html") {
                document.getElementById("mainApp").style.display = "none";
                document.getElementById("redirectMsg").style.display = "block";

                try {
                    const docRef = doc(db, "links", path);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        window.location.href = docSnap.data().url;
                    } else {
                        document.getElementById("redirectMsg").innerHTML = "<h2>Link tidak ditemukan :(</h2><a href='/'>Buat baru</a>";
                    }
                } catch (error) {
                    console.error("Error:", error);
                    document.getElementById("redirectMsg").innerText = "Terjadi kesalahan koneksi database.";
                }
            }
        }

        // --- FUNGSI 2: MEMBUAT SHORTLINK ---
        window.shortenUrl = async function() {
            const longUrl = document.getElementById('longUrl').value;
            let code = document.getElementById('customCode').value;
            const resultDiv = document.getElementById('result');

            if (!longUrl) return alert("Isi linknya dulu dong!");

            // Jika kode kosong, buat acak
            if (!code) {
                code = Math.random().toString(36).substring(2, 7);
            }

            resultDiv.innerHTML = "<span class='loading'>Memproses...</span>";

            try {
                // Simpan ke database
                await setDoc(doc(db, "links", code), {
                    url: longUrl,
                    createdAt: new Date()
                });

                const shortUrl = window.location.origin + "/" + code;
                resultDiv.innerHTML = `Berhasil! Link kamu:<br><a href="${shortUrl}" target="_blank" style="color:#e94560">${shortUrl}</a>`;
            } catch (error) {
                console.error(error);
                // Pesan error khusus jika permission denied
                if(error.code === 'permission-denied') {
                     resultDiv.innerText = "Gagal: Database belum disetting ke Test Mode.";
                } else {
                     resultDiv.innerText = "Gagal membuat link. Cek konsol.";
                }
            }
        }

        checkRedirect();
    </script>
</body>
</html>